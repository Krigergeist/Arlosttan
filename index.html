<!DOCTYPE html>
<html lang="en" x-data="rpgGame()" x-init="init()">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arlosttan RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <link rel="icon" href="resource/img/sword.png">
</head>

<body class="bg-zinc-950 font-mono flex items-center justify-center min-h-screen">

    <div class="w-[600px] border-4 border-white bg-zinc-950 p-3 space-y-3">

        <!-- === Landing Page === -->
        <template x-if="page==='landing'">
            <div class="relative text-center space-y-5">
                <img src="resource/img/Arlosttan logo.png" class="mx-auto ">
                <button 
                    class="
                    absolute top-[32%] left-[42%]
                    w-28 h-28"
                    @click="page = 'map'"
                >
                    <p class="text-white/0 ">Start</p>
                </button>
            </div>
        </template>
        
        <!-- === Map Page === -->
        <template x-if="page==='map'">
            <div class="relative">
                <img src="resource/img/Arlosttan Map.png" class="mx-auto">
        
                <!-- Region 1 (Stage 1–5) -->
                <button :class="stageClass(0,0)" style="top:65%; left:25%;" @click="enterStage(0,0)">1</button>
                <button :class="stageClass(0,1)" style="top:76%; left:27%;" @click="enterStage(0,1)">2</button>
                <button :class="stageClass(0,2)" style="top:65%; left:34%;" @click="enterStage(0,2)">3</button>
                <button :class="stageClass(0,3)" style="top:62%; left:45%;" @click="enterStage(0,3)">4</button>
                <button :class="stageClass(0,4)" style="top:58%; left:23%;" @click="enterStage(0,4)">5</button>
        
                <!-- Region 2 (Stage 6–10) -->
                <button :class="stageClass(1,0)" style="top:47%; left:65%;" @click="enterStage(1,0)">6</button>
                <button :class="stageClass(1,1)" style="top:32%; left:70%;" @click="enterStage(1,1)">7</button>
                <button :class="stageClass(1,2)" style="top:20%; left:77%;" @click="enterStage(1,2)">8</button>
                <button :class="stageClass(1,3)" style="top:20%; left:61%;" @click="enterStage(1,3)">9</button>
                <button :class="stageClass(1,4)" style="top:27%; left:34%;" @click="enterStage(1,4)">10</button>
        
                <!-- Back button -->
                <button
                    class="absolute top-[7%] left-[5%] border-2 border-white bg-black/60 px-2 py-1 text-white hover:bg-white hover:text-black"
                    @click="page = 'landing'">Back</button>
            </div>
        </template>


        <!-- === Battlefield Page === -->
        <template x-if="page === 'battle'">
            <div class="space-y-3">
                <!-- Log -->
                <div class="border-2 border-white bg-black text-blue-50 h-24 overflow-y-auto p-2 text-sm" x-ref="logBox">
                    <template x-for="(msg,i) in messages" :key="i">
                        <p x-text="msg"></p>
                    </template>
                </div>

                <!-- Arena -->
                <div class="flex justify-between gap-3">
                    <div class="text-center w-1/2">
                        <div class="border-2 border-white bg-black text-blue-50 h-20 flex items-center justify-center mb-1">
                            [Player]</div>
                        <p>Player</p>
                    </div>
                    <div class="text-center w-1/2">
                        <div class="border-2 border-white bg-black text-blue-50 h-20 flex items-center justify-center mb-1">
                            [Enemy]</div>
                        <p x-text="enemy.name"></p>
                    </div>
                </div>

                <!-- HP -->
                <div class="flex justify-between gap-3">
                    <div class="border-2 border-white bg-black text-blue-50 w-1/2 text-center p-1">
                        HP: <span x-text="player.hp"></span>
                    </div>
                    <div class="border-2 border-white bg-black text-blue-50 w-1/2 text-center p-1">
                        HP: <span x-text="enemy.hp"></span>
                    </div>
                </div>

                <!-- Tombol Aksi Player -->
                <div class="flex gap-3" style="max-height: 100px;">
                    <div class="w-1/2 flex flex-col p-2 gap-3 max-h-24 overflow-y-auto border-2 border-white bg-black text-blue-50">
                        <button class="border-2 border-white bg-black text-blue-50 p-1 hover:bg-gray-200/20"
                            @click="chooseAction('attack')">Attack</button>
                        <button class="border-2 border-white bg-black text-blue-50 p-1 hover:bg-gray-200/20 text-blue-50"
                            @click="chooseAction('defend')">Defend</button>
                    </div>
                
                    <div class="w-1/2 flex flex-col p-1 gap-3 max-h-24 overflow-y-auto border-2 border-white bg-black text-blue-50">
                        <template x-if="actionChosen === 'attack'">
                            <div class="flex flex-col gap-1">
                                <button class="border border-white bg-black text-blue-50 p-2 hover:bg-gray-200/20" @click="doAttack('Sword')">Sword</button>
                                <button class="border border-white bg-black text-blue-50 p-2 hover:bg-gray-200/20" @click="doAttack('Magic')">Magic</button>
                                <button class="border border-white bg-black text-blue-50 p-2 hover:bg-gray-200/20" @click="doAttack('Skill')">Skill</button>
                                <button class="border border-white bg-black text-blue-50 p-2 hover:bg-gray-200/20" @click="doAttack('Bow')">Bow</button>
                                <button class="border border-white bg-black text-blue-50 p-2 hover:bg-gray-200/20" @click="doAttack('Spear')">Spear</button>
                            </div>
                        </template>
                
                        <template x-if="actionChosen === 'defend'">
                            <div class="flex flex-col gap-1">
                                <button class="border border-white bg-black text-blue-50 p-1 hover:bg-gray-200/20" @click="doDefend('Shield')">Shield</button>
                                <button class="border border-white bg-black text-blue-50 p-1 hover:bg-gray-200/20" @click="doDefend('Dodge')">Dodge</button>
                                <button class="border border-white bg-black text-blue-50 p-1 hover:bg-gray-200/20" @click="doDefend('Magic Barrier')">Magic
                                    Barrier</button>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- Tombol Save & Load -->
                <div class="flex justify-between mt-3">
                    <button class="border-2 border-black bg-green-200 px-2 py-1 hover:bg-green-300" 
                    @click="saveGame">Save</button>
                    <input type="file" id="loadFile" class="hidden" @change="loadGame($event)">
                    <button class="border-2 border-black bg-blue-200 px-2 py-1 hover:bg-blue-300"
                        @click="document.getElementById('loadFile').click()">Load</button>
                </div>
            </div>
        </template>

    </div>
    <!-- Script Game -->
    <script src="resource/js/gamedata.js"></script>
    <script src="resource/js/game.js"></script>
    <script>
        function rpgGame() {
            return {
                page: 'landing',
                player: { hp: 100, attack: 20 },
                enemy: null,
                messages: [],
                actionChosen: null,
                regions: [
                    Array.from({ length: 5 }, (_, i) => ({ status: i === 0 ? 'next' : 'locked' })), // Region 1
                    Array.from({ length: 5 }, () => ({ status: 'locked' })) // Region 2
                ],
                currentRegion: null,
                currentStage: null,

                init() {
                    this.$watch("messages", () => {
                        this.$refs.logBox && (this.$refs.logBox.scrollTop = this.$refs.logBox.scrollHeight);
                    });
                },

                stageClass(region, stage) {
                    const status = this.regions[region][stage].status;
                    return [
                        "absolute w-8 h-8", // base
                        status === "cleared" ? "border-2 border-white bg-black text-blue-50" : "",
                        status === "next" ? "border-2 border-white bg-black/60 text-blue-50 hover:bg-white hover:text-black" : "",
                        status === "locked" ? "border-2 border-gray-600 bg-black/30 text-gray-400 cursor-not-allowed" : ""
                    ].join(" ");
                },

                // Map → Battle
                enterStage(region, stage) {
                    if (this.regions[region][stage].status !== 'next') return;
                    this.currentRegion = region;
                    this.currentStage = stage;
                    this.resetBattle();
                    this.page = 'battle';
                },

                // Reset battle → pilih musuh random dari GameDB
                resetBattle() {
                    this.player.hp = 100;

                    const randIndex = Math.floor(Math.random() * GameDB.enemies.length);
                    this.enemy = JSON.parse(JSON.stringify(GameDB.enemies[randIndex]));

                    this.messages = [`Pertarungan dimulai! Musuh muncul: ${this.enemy.name}`];
                    this.actionChosen = null;
                },

                // Battle actions
                chooseAction(type) {
                    this.actionChosen = type;
                    this.messages.push(`Player memilih ${type}`);
                },
                doAttack(type) {
                    if (this.enemy.hp <= 0) return;
                    this.enemy.hp -= this.player.attack;
                    if (this.enemy.hp < 0) this.enemy.hp = 0;
                    this.messages.push(`Player menyerang dengan ${type}, ${this.player.attack} damage`);
                    if (this.enemy.hp <= 0) {
                        this.messages.push("Musuh dikalahkan!");
                        this.stageCleared();
                    } else {
                        this.enemyTurn();
                    }
                    this.actionChosen = null;
                },
                doDefend(type) {
                    this.messages.push(`Player bertahan dengan ${type}`);
                    this.enemyTurn(true);
                    this.actionChosen = null;
                },
                enemyTurn(defended = false) {
                    if (this.enemy.hp <= 0) return;
                    let dmg = defended ? Math.floor(this.enemy.attack / 2) : this.enemy.attack;
                    this.player.hp -= dmg;
                    if (this.player.hp < 0) this.player.hp = 0;
                    this.messages.push(`${this.enemy.name} menyerang! Player -${dmg} HP`);
                    if (this.player.hp <= 0) {
                        this.messages.push("Player kalah... Game Over!");
                        this.page = 'map';
                    }
                },

                saveGame() {
                    const data = {
                        player: this.player,
                        enemy: this.enemy
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "gameData.json";
                    a.click();
                    URL.revokeObjectURL(url);
                    this.messages.push("Game berhasil disimpan!");
                },

                loadGame(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            this.player = data.player;
                            this.enemy = data.enemy;
                            this.messages.push("Game berhasil dimuat!");
                        } catch (err) {
                            this.messages.push("Gagal memuat data.");
                        }
                    };
                    reader.readAsText(file);
                },

                // Stage selesai
                stageCleared() {
                    this.regions[this.currentRegion][this.currentStage].status = 'cleared';
                    let next = this.currentStage + 1;
                    if (next < this.regions[this.currentRegion].length) {
                        this.regions[this.currentRegion][next].status = 'next';
                    }
                    this.page = 'map';
                }
            }
        }
    </script>
</body>
</html>